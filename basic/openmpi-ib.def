# ---------------------------------------------------------------------------
#
# Create Ubuntu image with OpenMPI (InfiniBand + cluster-ready)
#
# Builds OpenMPI with UCX, rdma-core, libfabric, and PMIx support for
# high-performance multi-node communication over InfiniBand fabrics.
# MCA defaults prefer UCX/IB transport, falling back to TCP.
#
# Build
#   apptainer build ompi.sif openmpi.def
#
# Note
#   apptainer version 1.3.1
#
# ---------------------------------------------------------------------------
Bootstrap: docker
From: {{ OS_DISTRO }}:{{ OS_VERSION }}

%arguments
    OS_DISTRO=ubuntu
    OS_VERSION=24.04
    MPI_IMPLEMENTATION=openmpi
    MPI_VERSION=4.1.5
    BUILD_FROM_SOURCE=false

%files
    partials/info /usr/bin/info

%post -c /bin/bash
    set -e
    export DEBIAN_FRONTEND=noninteractive
    apt-get update

    if [ "{{ BUILD_FROM_SOURCE }}" = "true" ]; then
    # ===================================================================
    # Source build: UCX + OpenMPI from tarballs
    # ===================================================================
    apt-get -y install --no-install-recommends \
        curl wget gcc g++ gfortran make file jq ca-certificates bzip2 git openssh-client \
        libibverbs-dev librdmacm-dev rdma-core ibverbs-utils \
        libfabric-dev \
        libnuma-dev numactl \
        libpmix-dev libpmix-bin libpmix2 \
        libhwloc-dev hwloc \
        libevent-dev \
        pkg-config automake autoconf libtool flex

    # -------------------------------------------------------------------
    # Build UCX with InfiniBand verbs + shared-memory + RDMA-CM support
    # -------------------------------------------------------------------
    export UCX_VERSION=1.17.0
    mkdir -p /tmp/ucx
    cd /tmp/ucx
    curl -L -o ucx-${UCX_VERSION}.tar.gz \
        https://github.com/openucx/ucx/releases/download/v${UCX_VERSION}/ucx-${UCX_VERSION}.tar.gz
    tar -xzf ucx-${UCX_VERSION}.tar.gz
    cd ucx-${UCX_VERSION}
    ./configure \
        --prefix=/opt/ucx \
        --enable-mt \
        --with-verbs \
        --with-rdmacm \
        --with-rc \
        --with-ud \
        --with-dc \
        --with-cm
    make -j$(nproc) install
    rm -rf /tmp/ucx

    # -------------------------------------------------------------------
    # Build OpenMPI with UCX, verbs, PMIx, libfabric, hwloc
    # -------------------------------------------------------------------
    export MPI_VERSION={{ MPI_VERSION }}
    export OMPI_DIR=/opt/ompi
    ompi_short=$(echo {{ MPI_VERSION }} | cut -d '.' -f1-2)
    export OMPI_URL="https://download.open-mpi.org/release/open-mpi/v${ompi_short}/openmpi-{{ MPI_VERSION }}.tar.bz2"
    mkdir -p $OMPI_DIR /tmp/ompi
    cd /tmp/ompi && curl -O $OMPI_URL && tar -xjf openmpi-$MPI_VERSION.tar.bz2
    cd /tmp/ompi/openmpi-$MPI_VERSION
    ./configure \
        --prefix=$OMPI_DIR \
        --with-ucx=/opt/ucx \
        --with-verbs \
        --with-ofi \
        --with-pmix=external \
        --with-libevent=external \
        --with-hwloc=external \
        --enable-mpi-cxx \
        --enable-mpirun-prefix-by-default \
        --disable-static
    make -j$(nproc) install
    rm -rf /tmp/ompi

    # -------------------------------------------------------------------
    # Environment setup for source build
    # -------------------------------------------------------------------
    export PATH=$OMPI_DIR/bin:/opt/ucx/bin:$PATH
    export LD_LIBRARY_PATH=$OMPI_DIR/lib:/opt/ucx/lib:$LD_LIBRARY_PATH
    cat > ${OMPI_DIR}/bashrc <<'BASHRC'
export OMPI_DIR=/opt/ompi
export UCX_DIR=/opt/ucx
export PATH=${OMPI_DIR}/bin:${UCX_DIR}/bin:${PATH}
export LD_LIBRARY_PATH=${OMPI_DIR}/lib:${OMPI_DIR}/lib/openmpi:${UCX_DIR}/lib:${LD_LIBRARY_PATH}
export MANPATH=${OMPI_DIR}/share/man:${MANPATH}

# Prefer UCX PML (point-to-point messaging layer) over ob1
export OMPI_MCA_pml=ucx

# UCX transport: try InfiniBand RC first, then shared memory, then TCP as fallback
export UCX_TLS=rc_verbs,rc_mlx5,ud_verbs,ud_mlx5,shm,self,tcp

# Use external PMIx for Slurm integration
export OMPI_MCA_pmix=external

# Bind-to core by default for reproducible placement
export OMPI_MCA_hwloc_base_binding_policy=core
BASHRC

    else
    # ===================================================================
    # Repo install: OpenMPI + UCX from Ubuntu packages (default)
    # ===================================================================
    apt-get -y install --no-install-recommends \
        jq ca-certificates file openssh-client \
        openmpi-bin openmpi-common libopenmpi-dev \
        libucx0 ucx-utils \
        libibverbs-dev librdmacm-dev rdma-core ibverbs-utils \
        libnuma-dev numactl \
        libpmix-dev libpmix-bin libpmix2 \
        libhwloc-dev hwloc

    export OMPI_DIR=/usr
    cat > /opt/ompi-bashrc <<'BASHRC'
export OMPI_DIR=/usr

# Prefer UCX PML (point-to-point messaging layer) over ob1
export OMPI_MCA_pml=ucx

# UCX transport: try InfiniBand RC first, then shared memory, then TCP as fallback
export UCX_TLS=rc_verbs,rc_mlx5,ud_verbs,ud_mlx5,shm,self,tcp

# Use external PMIx for Slurm integration
export OMPI_MCA_pmix=external

# Bind-to core by default for reproducible placement
export OMPI_MCA_hwloc_base_binding_policy=core
BASHRC

    fi

    # -----------------------------------------------------------------------
    # Register in /apps.json
    # -----------------------------------------------------------------------
    if [ "{{ BUILD_FROM_SOURCE }}" = "true" ]; then
        BASHRC_PATH="/opt/ompi/bashrc"
    else
        BASHRC_PATH="/opt/ompi-bashrc"
    fi
    echo '{}' > /apps.json
    jq --arg app openmpi --arg src "$BASHRC_PATH" \
        '.[$app] |= if . == null then
        {
            version: "{{ MPI_VERSION }}",
            source_script: $src
        }
        else . +
        {
            version: "{{ MPI_VERSION }}",
            source_script: $src
        } end' /apps.json > /tmp/apps.json
    mv /tmp/apps.json /apps.json

%environment
    #!/bin/bash
    _envfile=$(mktemp)
    _scriptfile=$(mktemp)

    # Get all source scripts
    jq -r '.. | .source_script? // empty' /apps.json > "$_scriptfile"

    # Source them in bash and dump the environment
    /bin/bash -c "
        while IFS= read -r script; do
          if [ -f \"\$script\" ]; then
            source \"\$script\"
          fi
        done < \"$_scriptfile\"
        export -p
    " > "$_envfile"

    # Import the environment into current shell
    . "$_envfile"

    # Handle python environments
    jq -r '.. | .python_env? // empty' /apps.json > "$_scriptfile"
    while IFS= read -r script; do
      if [ -d "$script" ]; then
        . "$script/bin/activate"
      fi
    done < "$_scriptfile"

    # Handle uv environments
    jq -r '.. | .uv_env? // empty' /apps.json > "$_scriptfile"
    while IFS= read -r script; do
      if [ -f "$script" ]; then
        . "$script"
      fi
    done < "$_scriptfile"

    rm -f "$_envfile" "$_scriptfile"

%runscript
    #!/bin/bash
    if [ $# -eq 0 ]; then
        exec /bin/bash
    else
        exec "$@"
    fi

%labels
    Maintainer Mohammed Elwardi Fadeli
    Description Ubuntu-based OpenMPI image with InfiniBand (UCX + verbs) and PMIx support
    AppsFile /apps.json
